# SLO workload

SLO is the type of test where app based on ydb-sdk is tested against falling YDB cluster nodes, tablets, network
(that is possible situations for distributed DBs with hundreds of nodes)

It has 3 commands:

- `create`  - creates table in database
- `cleanup` - drops table in database
- `run`     - runs workload (read and write to table with sets RPS)

### Run examples with all arguments:

create:
`slo-go-workload create create grpcs://ydb.cool.example.com:2135 /some/folder -t tableName`

cleanup:
`slo-go-workload create cleanup grpcs://ydb.cool.example.com:2135 /some/folder -t tableName`

run:
`slo-go-workload create run grpcs://ydb.cool.example.com:2135 /some/folder -t tableName
-prom-pgw http://prometheus-pushgateway:9091 -report-period 250
-read-rps 1000 -read-timeout 10000
-write-rps 100 -write-timeout 10000
-time 600 -shutdown-time 30`

## Arguments for commands:

### create
`slo-go-workload create <endpoint> <db> [options]`

```
Arguments:
  endpoint                        YDB endpoint to connect to
  db                              YDB database to connect to

Options:
  -a <token>                      YDB access token credentials
  -t <tableName>                  table name to create
```

### cleanup
`slo-go-workload cleanup <endpoint> <db> [options]`

```
Arguments:
  endpoint                        YDB endpoint to connect to
  db                              YDB database to connect to

Options:
  -a <token>                      YDB access token credentials
  -t <tableName>                  table name to drop
```

### run
`slo-go-workload run <endpoint> <db> [options]`

```
Arguments:
  endpoint                        YDB endpoint to connect to
  db                              YDB database to connect to

Options:
  -a <token>                      YDB access token credentials
  -t <tableName>                  table name
  --prom-pgw <promPgw>            prometheus push gateway
  --read-rps <readRps>            read RPS
  --read-timeout <readTimeout>    read timeout milliseconds
  --write-rps <writeRps>          write RPS
  --write-timeout <writeTimeout>  write timeout milliseconds
  --time <time>                   run time in seconds
  --shutdown-time <shutdownTime>  graceful shutdown time in seconds
  --report-period <reportPeriod>  prometheus push period in milliseconds
```


## What's inside
When running `run` command, the program creates three jobs: `readJob`, `writeJob`, `metricsJob`.

- `readJob`    reads rows from the table one by one with random identifiers generated by writeJob
- `writeJob`   generates and inserts rows
- `metricsJob` periodically sends metrics to Prometheus

Table have these fields:
- `id (primary) Utf8`
- `payload Utf8`

## Collected metrics
- `oks`      - amount of OK requests
- `not_oks`  - amount of not OK requests
- `inflight` - amount of requests in flight
- `latency`  - summary of latencies in ms

> You must reset metrics to keep them `0` in prometheus and grafana before beginning and after ending of jobs

In `go` it looks like that:
```go
func (m *Metrics) Reset() error {
    m.oks.WithLabelValues(JobRead).Set(0)
    m.oks.WithLabelValues(JobWrite).Set(0)

    m.notOks.WithLabelValues(JobRead).Set(0)
    m.notOks.WithLabelValues(JobWrite).Set(0)

    m.inflight.WithLabelValues(JobRead).Set(0)
    m.inflight.WithLabelValues(JobWrite).Set(0)

    m.latencies.Reset()

    return m.Push()
}
```

## Look at metrics in grafana
You can get dashboard used in that test [here](https://github.com/ydb-platform/slo-tests/blob/main/k8s/helms/grafana.yaml#L69) - you will need to import json into grafana.
